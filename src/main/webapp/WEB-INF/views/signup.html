<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="fragments/page">

<body class="signup">

<!--/* No nav dropdown for this page */-->
<div layout:fragment="nav"></div>

<div class="container" layout:fragment="bodyContent">

    <div class="page-header">
        <h1>Choose your cloud name:</h1>
    </div>

    <form action="#" th:action="@{/signup}" method="post"
          class="form-primary" role="form" th:object="${signUpInfo}"
          autocomplete="off" accept-charset="UTF-8" id="signup">

        <div class="form-group" id="cloudNameGroup">
            <input type="text" id="cloudName" name="cloudName" class="form-control" placeholder="=you..."
                   autofocus="autofocus" required="required" />
            <span id="cloudNameHelpIcon" class="glyphicon glyphicon-ok form-control-feedback hidden"></span>
            <span id="cloudNameHelp" class="form-control-feedback"></span>
        </div>

        <p class="secondary">e.g., =jane, =janedoe, =jane.doe</p>

        <button type="submit" name="submitBtn" id="submitBtn" class="btn btn-lg btn-primary">Next</button>

        <input type="hidden" name="giftCode" id="giftCode" th:value="*{giftCode}" th:if="${signUpInfo} != null"/>
    </form>
</div>

<th:block layout:fragment="postFooterContent">
    <script src="js/libs/nameavailability.js"></script>
    <script>

        $(document).ready(function () {

            var cloudNameGroup = $('#cloudNameGroup');
            var cloudNameHelpIcon = $('#cloudNameHelpIcon');

            // the value of this var is the id of the input element
            // that the user is typing into
            var cloudNameField = "#cloudName";
            var cloudNameInput = $(cloudNameField);

            // the value of this var is the id of the display element
            // that will be used to convey information to the user
            var messageSpan = $(cloudNameField + 'Help');

            var isAvailable = false;

            cloudNameInput.checkCloud({

                completed: function (elem, success) {

                    // no longer loading
                    cloudNameInput.removeClass('btn-primary-loading');

                    // reset view state
                    cloudNameGroup.removeClass('has-success has-warning has-error');
                    cloudNameHelpIcon.addClass('hidden');
                    cloudNameHelpIcon.removeClass('glyphicon-ok glyphicon-remove glyphicon-warning-sign');

                    // success var will contain a 1 if the name is available and 0 if it not available.
                    console.log('Checking cloud... :: success=' + success);

                    // clear error
                    if (cloudNameInput.val().trim() == '') {
                        messageSpan.html('');
                        return;
                    }

                    cloudNameHelpIcon.removeClass('hidden');

                    if (success === 1) { // available
                        messageSpan.html('Your cloud name is available');
                        cloudNameGroup.addClass('has-success');
                        cloudNameHelpIcon.addClass('glyphicon-ok');
                        isAvailable = true;
                    } else if (success === 0) { // unavailable
                        messageSpan.html("This cloud name is NOT available");
                        cloudNameGroup.addClass('has-warning');
                        cloudNameHelpIcon.addClass('glyphicon-warning-sign');
                    } else { // formatting error
                        cloudNameGroup.addClass('has-error');
                        messageSpan.html("Cloud names must contain at least 2 letters, numbers, or dots");
                        cloudNameHelpIcon.addClass('glyphicon-remove');
                    }
                },

                // user is typing
                changed: function (elem) {
                    isAvailable = false;
                    cloudNameInput.addClass('btn-primary-loading');
                    console.log('Changing cloud...');
                },

                // indicates if the leading symbol should be removed prior to adding the name to the path
                stripSymbol: true,

                // indicates the location of the availability service
                availabilityApi: /*[[${signUpInfo.nameAvailabilityCheckURL + '/api/availability/equals/'}]]*/ "https://checkavailability-prod.respectnetwork.net/api/availability/equals/"
            });

            $('#signup').validate({
                rules: {
                    cloudName: {
                        required: true,
                        minlength: 3
                    }
                },
                debug: true,
                submitHandler: function(form) {
                    if (isAvailable) {
                        form.submit();
                    } else {
                        cloudNameInput.focus();
                    }
                },
                errorPlacement: function(error, element) {
                    // nothing - using custom error msgs
                }
            });
        });

    </script>
</th:block>

</body>

</html>
